# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

name: python-maturin-pre-merge
description: Python pre-merge testing with maturin github iggy actions

inputs:
  task:
    description: "Task to run (lint, test, build)"
    required: true

runs:
  using: "composite"
  steps:
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Setup Rust with cache
      uses: ./.github/actions/utils/setup-rust-with-cache

    - name: Install llvm-tools for coverage
      if: inputs.task == 'test'
      run: rustup component add llvm-tools-preview
      shell: bash

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Cache uv
      uses: actions/cache@v4
      with:
        path: ~/.cache/uv
        key: uv-${{ runner.os }}-${{ hashFiles('examples/python/uv.lock', 'foreign/python/uv.lock', 'bdd/python/uv.lock') }}

    - name: Install dependencies
      shell: bash
      run: |
        cd foreign/python
        if [ "${{ inputs.task }}" = "test" ]; then
          uv sync --frozen --extra dev --extra testing --extra testing-docker
        else
          uv sync --frozen --extra dev --extra testing
        fi

    - name: Lint and format check
      if: inputs.task == 'lint'
      run: |
        # Build list of directories to check
        DIR_SDK="${GITHUB_WORKSPACE}/foreign/python"
        DIR_BDD="${GITHUB_WORKSPACE}/bdd/python"
        DIR_EXAMPLES="${GITHUB_WORKSPACE}/examples/python"

        # Collect all Python directories that exist
        DIRS_TO_CHECK="$DIR_SDK"
        [ -d "$DIR_BDD" ] && DIRS_TO_CHECK="$DIRS_TO_CHECK $DIR_BDD"
        [ -d "$DIR_EXAMPLES" ] && DIRS_TO_CHECK="$DIRS_TO_CHECK $DIR_EXAMPLES"

        cd foreign/python

        echo "Directories to check: $DIRS_TO_CHECK"
        echo "ruff version: $(uv run ruff --version)"

        echo "Running ruff check..."
        uv run ruff check $DIRS_TO_CHECK

        echo "Running ruff format --check..."
        uv run ruff format --check $DIRS_TO_CHECK

        # mypy only for the SDK (has type stubs)
        echo "Running mypy on SDK..."
        uv run mypy --explicit-package-bases "$DIR_SDK"
        echo "mypy version: $(uv run mypy --version)"
      shell: bash

    - name: Build Python wheel with coverage instrumentation
      if: inputs.task == 'test'
      run: |
        cd foreign/python
        mkdir -p target/coverage

        # Instrument Rust code with coverage and set profraw output path
        export RUSTFLAGS="-C instrument-coverage"
        export LLVM_PROFILE_FILE="$(pwd)/target/coverage/%p-%4m.profraw"
        echo "LLVM_PROFILE_FILE=${LLVM_PROFILE_FILE}" >> $GITHUB_ENV

        echo "Building Python wheel with coverage instrumentation..."
        uv run maturin develop --release
      shell: bash

    - name: Build Python wheel
      if: inputs.task == 'build'
      run: |
        cd foreign/python

        # Build the module
        echo "Building Python wheel..."
        uv run maturin build -o dist

        # List built artifacts
        echo ""
        echo "Build artifacts:"
        ls -la dist/
      shell: bash

    - name: Start Iggy server
      if: inputs.task == 'test'
      id: iggy
      uses: ./.github/actions/utils/server-start
      continue-on-error: true

    - name: Run Python integration tests
      if: inputs.task == 'test' && steps.iggy.outcome == 'success'
      run: |
        cd foreign/python

        echo "Running integration tests with Iggy server at ${{ steps.iggy.outputs.address }}..."

        # Run all tests with server connection
        IGGY_SERVER_HOST=127.0.0.1 \
        IGGY_SERVER_TCP_PORT=8090 \
          uv run pytest tests/ -v \
            --junitxml=../../reports/python-junit.xml \
            --tb=short \
            --capture=no || TEST_EXIT_CODE=$?

        # Exit with test result
        exit ${TEST_EXIT_CODE:-0}
      shell: bash

    - name: Run Python unit tests only (fallback)
      if: inputs.task == 'test' && steps.iggy.outcome != 'success'
      run: |
        cd foreign/python

        echo "⚠️ Server failed to start, running unit tests only..."

        # Run unit tests only (exclude integration tests)
        uv run pytest tests/ -v \
          -m "not integration" \
          --junitxml=../../reports/python-junit.xml \
          --tb=short || TEST_EXIT_CODE=$?

        # Exit with test result (allow some failures in unit-only mode)
        exit ${TEST_EXIT_CODE:-0}
      shell: bash

    - name: Stop Iggy server
      if: always() && inputs.task == 'test'
      uses: ./.github/actions/utils/server-stop
      with:
        pid-file: ${{ steps.iggy.outputs.pid_file }}
        log-file: ${{ steps.iggy.outputs.log_file }}

    - name: Generate coverage report
      if: inputs.task == 'test'
      run: |
        mkdir -p reports
        cd foreign/python

        PROFRAW_COUNT=$(find target/coverage -name '*.profraw' 2>/dev/null | wc -l)
        echo "Found ${PROFRAW_COUNT} profraw file(s)"

        if [ "${PROFRAW_COUNT}" -eq 0 ]; then
          echo "No profraw files found, skipping coverage report"
          exit 0
        fi

        LLVM_PROFDATA=$(find "$(rustc --print sysroot)" -name 'llvm-profdata' -type f | head -1)
        LLVM_COV=$(find "$(rustc --print sysroot)" -name 'llvm-cov' -type f | head -1)
        SHARED_LIB=$(find target/release -name 'libapache_iggy*.so' 2>/dev/null | head -1)

        "${LLVM_PROFDATA}" merge -sparse target/coverage/*.profraw -o target/coverage/merged.profdata

        "${LLVM_COV}" export \
          --format=lcov \
          --instr-profile=target/coverage/merged.profdata \
          --ignore-filename-regex='(/.cargo/registry|/rustc/)' \
          "${SHARED_LIB}" \
          > ../../reports/python-coverage.lcov

        echo "Coverage report generated: $(wc -l < ../../reports/python-coverage.lcov) lines"
      shell: bash

    - name: Upload test artifacts
      if: always() && inputs.task == 'test'
      uses: actions/upload-artifact@v4
      with:
        name: python-test-results-${{ github.run_id }}-${{ github.run_attempt }}
        path: |
          reports/python-junit.xml
          reports/python-coverage.lcov
          foreign/python/dist/*.whl
        retention-days: 7
        if-no-files-found: ignore
