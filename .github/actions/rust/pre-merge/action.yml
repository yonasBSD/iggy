# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

name: rust-pre-merge
description: Rust pre-merge testing and linting github iggy actions

inputs:
  task:
    description: "Task to run (check, fmt, clippy, sort, machete, doctest, test, compat)"
    required: true
  component:
    description: "Component name (for context)"
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    - name: Cleanup disk space
      run: |
        echo "Disk space before cleanup:"
        df -h
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        # sudo docker image prune --all --force
        # sudo docker builder prune -a
        echo "Disk space after cleanup:"
        df -h
      shell: bash

    - name: Setup Rust with cache
      uses: ./.github/actions/utils/setup-rust-with-cache
      with:
        print-cache-status: ${{ inputs.task == 'test' }}

    - name: Install tools for specific tasks
      run: |
        case "${{ inputs.task }}" in
          sort)
            cargo install cargo-sort --locked
            ;;
          machete)
            cargo install cargo-machete --locked
            ;;
        esac
      shell: bash

    # Individual lint tasks for parallel execution
    - name: Cargo check
      if: inputs.task == 'check'
      run: cargo check --all --all-features
      shell: bash

    - name: Cargo fmt
      if: inputs.task == 'fmt'
      run: cargo fmt --all -- --check
      shell: bash

    - name: Cargo clippy
      if: inputs.task == 'clippy'
      run: cargo clippy --all-targets --all-features -- -D warnings
      shell: bash

    - name: Cargo sort
      if: inputs.task == 'sort'
      run: cargo sort --check --workspace
      shell: bash

    - name: Cargo machete
      if: inputs.task == 'machete'
      run: cargo machete --with-metadata
      shell: bash

    - name: Doc test
      if: inputs.task == 'doctest'
      run: |
        cargo test --locked --doc
        cargo doc --no-deps --all-features --quiet
      shell: bash

    - name: Install dependencies for Rust tests
      if: inputs.task == 'test' && runner.os == 'Linux'
      run: |
        sudo apt-get update --yes && sudo apt-get install --yes musl-tools gnome-keyring keyutils
        rm -f $HOME/.local/share/keyrings/*
        echo -n "test" | gnome-keyring-daemon --unlock
      shell: bash

    - name: Install cargo-llvm-cov
      if: inputs.task == 'test'
      uses: taiki-e/install-action@v2
      with:
        tool: cargo-llvm-cov

    - name: Build and test with coverage
      if: inputs.task == 'test'
      run: |
        source <(cargo llvm-cov show-env --export-prefix)

        bins_start=$(date +%s)
        cargo build --locked
        bins_end=$(date +%s)
        bins_duration=$((bins_end - bins_start))
        echo "::notice::Binaries and libraries built in ${bins_duration}s ($(date -ud @${bins_duration} +'%M:%S'))"

        compile_start=$(date +%s)
        cargo test --locked --no-run
        compile_end=$(date +%s)
        compile_duration=$((compile_end - compile_start))
        echo "::notice::Tests compiled in ${compile_duration}s ($(date -ud @${compile_duration} +'%M:%S'))"

        test_start=$(date +%s)
        if command -v cargo-nextest &> /dev/null; then
          cargo nextest run --locked --no-fail-fast
        else
          cargo test --locked --no-fail-fast
        fi
        test_end=$(date +%s)
        test_duration=$((test_end - test_start))
        echo "::notice::Tests executed in ${test_duration}s ($(date -ud @${test_duration} +'%M:%S'))"

        build_duration=$((bins_duration + compile_duration))
        total_duration=$((build_duration + test_duration))
        echo ""
        echo "========================================="
        echo "All targets build:             ${bins_duration}s ($(date -ud @${bins_duration} +'%M:%S'))"
        echo "Tests compile:                 ${compile_duration}s ($(date -ud @${compile_duration} +'%M:%S'))"
        echo "Tests execute:                 ${test_duration}s ($(date -ud @${test_duration} +'%M:%S'))"
        echo "-----------------------------------------"
        echo "Total build:                   ${build_duration}s ($(date -ud @${build_duration} +'%M:%S'))"
        echo "Total time:                    ${total_duration}s ($(date -ud @${total_duration} +'%M:%S'))"
        echo "========================================="

        cargo llvm-cov report --codecov --output-path codecov.json
        echo "Coverage report generated: codecov.json"
        ls -la codecov.json
      shell: bash

    - name: Backwards compatibility check
      if: inputs.task == 'compat' && (github.event_name != 'pull_request' || !contains(github.event.pull_request.body || '', 'BREAKING'))
      run: |
        scripts/check-backwards-compat.sh \
          --master-ref master \
          --pr-ref ${{ github.sha }} \
          --port 8090 --wait-secs 180
      shell: bash

    # aarch64 builds (run on ARM64 runners)
    - name: Build aarch64-gnu
      if: inputs.task == 'build-aarch64-gnu'
      run: cargo build --locked
      shell: bash

    - name: Install musl tools for aarch64-musl
      if: inputs.task == 'build-aarch64-musl' && runner.os == 'Linux'
      run: |
        sudo apt-get update && sudo apt-get install -y musl-tools
        rustup target add aarch64-unknown-linux-musl
      shell: bash

    - name: Build aarch64-musl
      if: inputs.task == 'build-aarch64-musl'
      run: cargo build --locked --target aarch64-unknown-linux-musl
      shell: bash
      env:
        # Disable GCC outline atomics to avoid undefined __aarch64_ldadd4_sync
        # references when linking dbus-sys (required by keyring crate)
        CFLAGS: "-mno-outline-atomics"
        PKG_CONFIG_ALLOW_CROSS: "1"
        PKG_CONFIG_ALL_STATIC: "1"

    # macOS builds
    - name: Build macOS aarch64
      if: inputs.task == 'build-macos-aarch64'
      run: cargo build --locked
      shell: bash
