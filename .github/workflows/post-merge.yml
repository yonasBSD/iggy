# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

name: Post-merge

on:
  push:
    branches: [master]

permissions:
  contents: write
  packages: write
  id-token: write

concurrency:
  group: post-merge-${{ github.ref }}
  cancel-in-progress: false

env:
  IGGY_CI_BUILD: true

jobs:
  check-auto-publish:
    name: Check auto-publish
    runs-on: ubuntu-latest
    if: ${{ !github.event.repository.fork }}
    outputs:
      docker_components: ${{ steps.check.outputs.docker_components }}
      crates_to_publish: ${{ steps.check.outputs.crates_to_publish }}
      sdks_to_publish: ${{ steps.check.outputs.sdks_to_publish }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup yq
        run: |
          if ! command -v yq >/dev/null 2>&1; then
            YQ_VERSION="v4.47.1"
            YQ_CHECKSUM="0fb28c6680193c41b364193d0c0fc4a03177aecde51cfc04d506b1517158c2fb"
            curl -sSL -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64
            echo "${YQ_CHECKSUM}  /usr/local/bin/yq" | sha256sum -c - || exit 1
            chmod +x /usr/local/bin/yq
          fi

      # TODO(hubcio): Add sdk-python (it has to contain `dev`), sdk-node, sdk-java (SNAPSHOT?), sdk-go (store version in file?) when ready for edge auto-publish
      - name: Check all components
        id: check
        run: |
          chmod +x scripts/extract-version.sh

          # Get all Docker components (always publish :edge)
          DOCKER_COMPONENTS=$(yq -r '.components | to_entries | .[] | select(.value.registry == "dockerhub") | .key' .github/config/publish.yml | tr '\n' ',' | sed 's/,$//')
          echo "docker_components=$DOCKER_COMPONENTS" >> "$GITHUB_OUTPUT"
          echo "Docker components: $DOCKER_COMPONENTS"

          # Check Rust crates for pre-release versions without tags
          CRATES_TO_PUBLISH=""
          for crate in rust-common rust-binary-protocol rust-sdk rust-cli; do
            VERSION=$(scripts/extract-version.sh "$crate")
            TAG=$(scripts/extract-version.sh "$crate" --tag)

            echo "Checking $crate: version=$VERSION, tag=$TAG"

            if [[ ! "$VERSION" =~ -(edge|rc) ]]; then
              echo "  ⏭️ Stable version - skipping"
              continue
            fi

            if git rev-parse "$TAG" >/dev/null 2>&1; then
              echo "  ⏭️ Tag exists - skipping"
              continue
            fi

            echo "  ✅ Will publish"
            CRATES_TO_PUBLISH="${CRATES_TO_PUBLISH:+$CRATES_TO_PUBLISH,}$crate"
          done
          echo "crates_to_publish=$CRATES_TO_PUBLISH" >> "$GITHUB_OUTPUT"
          echo "Crates to publish: ${CRATES_TO_PUBLISH:-<none>}"

          # Check SDKs for pre-release versions without tags
          SDKS_TO_PUBLISH=""
          for sdk in sdk-csharp; do
            VERSION=$(scripts/extract-version.sh "$sdk")
            TAG=$(scripts/extract-version.sh "$sdk" --tag)

            echo "Checking $sdk: version=$VERSION, tag=$TAG"

            if [[ ! "$VERSION" =~ -(edge|rc) ]]; then
              echo "  ⏭️ Stable version - skipping"
              continue
            fi

            if git rev-parse "$TAG" >/dev/null 2>&1; then
              echo "  ⏭️ Tag exists - skipping"
              continue
            fi

            echo "  ✅ Will publish"
            # Convert sdk-csharp to csharp for publish.yml input format
            SDK_NAME="${sdk#sdk-}"
            SDKS_TO_PUBLISH="${SDKS_TO_PUBLISH:+$SDKS_TO_PUBLISH,}$SDK_NAME"
          done
          echo "sdks_to_publish=$SDKS_TO_PUBLISH" >> "$GITHUB_OUTPUT"
          echo "SDKs to publish: ${SDKS_TO_PUBLISH:-<none>}"

  call-publish:
    name: Publish components
    needs: check-auto-publish
    uses: ./.github/workflows/publish.yml
    with:
      commit: ${{ github.sha }}
      dry_run: false
      use_latest_ci: false
      skip_tag_creation: false
      publish_crates: ${{ needs.check-auto-publish.outputs.crates_to_publish }}
      publish_dockerhub: ${{ needs.check-auto-publish.outputs.docker_components }}
      publish_other: ${{ needs.check-auto-publish.outputs.sdks_to_publish }}
      create_edge_docker_tag: true
    secrets: inherit

  build-artifacts:
    name: Build artifacts
    uses: ./.github/workflows/_build_rust_artifacts.yml
    with:
      version: edge
      upload_artifacts: true

  create-prerelease:
    name: Create edge pre-release
    runs-on: ubuntu-latest
    needs: build-artifacts
    if: needs.build-artifacts.result == 'success' && !github.event.repository.fork
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Get server version
        id: meta
        run: |
          chmod +x scripts/extract-version.sh
          server_version=$(scripts/extract-version.sh rust-server)
          echo "server_version=${server_version}" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          name: rust-artifacts-all
          path: ./artifacts

      - name: Delete existing edge release and tag
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if gh release view edge &>/dev/null; then
            echo "Deleting existing edge release and tag..."
            gh release delete edge --cleanup-tag --yes || echo "Delete failed, continuing..."
          fi

      - name: Create edge pre-release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: edge
          name: edge
          draft: false
          prerelease: true
          make_latest: false
          files: artifacts/*.tar.gz
          body: |
            Rolling edge build of Apache Iggy binaries and connector plugins.

            **This release is automatically updated on every push to master.**

            ## Binaries included
            - `iggy-server` - The server binary
            - `iggy` - The command-line interface
            - `iggy-bench` - The benchmarking tool
            - `iggy-connectors` - The connectors runtime

            ## Connector plugins included (.so)
            - `iggy_connector_elasticsearch_sink`
            - `iggy_connector_elasticsearch_source`
            - `iggy_connector_iceberg_sink`
            - `iggy_connector_postgres_sink`
            - `iggy_connector_postgres_source`
            - `iggy_connector_quickwit_sink`
            - `iggy_connector_random_source`
            - `iggy_connector_stdout_sink`

            ## Downloads

            ### Binaries
            - `iggy-x86_64-unknown-linux-gnu-edge.tar.gz` - Linux x86_64 (glibc)
            - `iggy-x86_64-unknown-linux-musl-edge.tar.gz` - Linux x86_64 (musl, static)
            - `iggy-aarch64-unknown-linux-gnu-edge.tar.gz` - Linux ARM64 (glibc)
            - `iggy-aarch64-unknown-linux-musl-edge.tar.gz` - Linux ARM64 (musl, static)

            ### Connector plugins
            - `iggy-connectors-x86_64-unknown-linux-gnu-edge.tar.gz` - Linux x86_64 (glibc)
            - `iggy-connectors-aarch64-unknown-linux-gnu-edge.tar.gz` - Linux ARM64 (glibc)

            ## Build info
            - Server version: ${{ steps.meta.outputs.server_version }}
            - Commit: ${{ github.sha }}

            **Not an official ASF release** - for development/testing only.
