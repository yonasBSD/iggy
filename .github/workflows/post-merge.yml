# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

name: Post-merge

on:
  push:
    branches: [master]

permissions:
  contents: read
  packages: write
  id-token: write

concurrency:
  group: post-merge-${{ github.ref }}
  cancel-in-progress: false

env:
  IGGY_CI_BUILD: true

jobs:
  plan:
    name: Plan dockerhub components
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.mk.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Load publish config (base64)
        id: cfg
        shell: bash
        run: |
          if ! command -v yq >/dev/null 2>&1; then
            YQ_VERSION="v4.47.1"
            YQ_CHECKSUM="0fb28c6680193c41b364193d0c0fc4a03177aecde51cfc04d506b1517158c2fb"
            curl -sSL -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64
            echo "${YQ_CHECKSUM}  /usr/local/bin/yq" | sha256sum -c - || exit 1
            chmod +x /usr/local/bin/yq
          fi
          echo "components_b64=$(yq -o=json -I=0 '.components' .github/config/publish.yml | base64 -w0)" >> "$GITHUB_OUTPUT"

      - name: Build matrix
        id: mk
        uses: actions/github-script@v7
        with:
          script: |
            const b64 = `${{ steps.cfg.outputs.components_b64 }}` || '';
            if (!b64) {
              core.setOutput('matrix', JSON.stringify({ include: [{ component: 'noop' }] }));
              return;
            }
            const comps = JSON.parse(Buffer.from(b64, 'base64').toString('utf8'));
            const include = Object.entries(comps)
              .filter(([_, v]) => v && v.registry === 'dockerhub')
              .map(([k]) => ({ component: k }));
            const uniq = Array.from(new Map(include.map(i => [i.component, i])).values());
            core.setOutput('matrix', JSON.stringify(uniq.length ? { include: uniq } : { include: [{ component: 'noop' }] }));

  docker-edge:
    name: ${{ matrix.component }}
    needs: plan
    if: ${{ fromJson(needs.plan.outputs.matrix).include[0].component != 'noop' }}
    runs-on: ubuntu-latest
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.plan.outputs.matrix) }}
    env:
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/utils/docker-buildx
        with:
          task: publish
          libc: musl
          component: ${{ matrix.component }}
          version: edge
          dry_run: ${{ github.event.repository.fork }} # forks: always dry-run

  build-rust-binaries:
    name: Build Rust binaries
    uses: ./.github/workflows/_build_rust_binaries.yml
    with:
      version: edge
      upload_artifacts: true

  create-prerelease:
    name: Create edge pre-release
    runs-on: ubuntu-latest
    needs: build-rust-binaries
    if: needs.build-rust-binaries.result == 'success' && !github.event.repository.fork
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Get server version
        id: meta
        run: |
          chmod +x scripts/extract-version.sh
          server_version=$(scripts/extract-version.sh rust-server)
          echo "server_version=${server_version}" >> "$GITHUB_OUTPUT"

      - name: Download edge artifacts
        uses: actions/download-artifact@v4
        with:
          name: rust-binaries-all
          path: ./artifacts

      - name: Delete existing edge release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          if gh release view edge &>/dev/null; then
            echo "Deleting existing edge release..."
            if ! gh release delete edge --yes; then
              echo "Release delete failed (likely already deleted by concurrent run), continuing."
            fi
          else
            echo "No existing edge release to delete"
          fi

      - name: Create edge pre-release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: edge
          name: Edge (latest)
          draft: false
          prerelease: true
          make_latest: false
          files: artifacts/**/*.tar.gz
          body: |
            Rolling edge build of Apache Iggy binaries.

            **This release is automatically updated on every push to master.**

            ## Binaries included
            - `iggy-server` - The server binary
            - `iggy` - The command-line interface
            - `iggy-bench` - The benchmarking tool

            ## Downloads
            - `iggy-x86_64-unknown-linux-gnu-edge.tar.gz` - Linux (glibc)
            - `iggy-x86_64-unknown-linux-musl-edge.tar.gz` - Linux (musl, static)

            ## Build info
            - Server version: ${{ steps.meta.outputs.server_version }}
            - Commit: ${{ github.sha }}

            ⚠️ **Not an official ASF release** - for development/testing only.
