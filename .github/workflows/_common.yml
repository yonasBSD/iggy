# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

name: _common
on:
  workflow_call:
    inputs:
      skip_pr_title:
        type: boolean
        required: false
        default: false
        description: "Skip PR title check (for push events)"

permissions:
  contents: read
  pull-requests: read

jobs:
  rust-versions:
    name: Check Rust versions sync
    runs-on: ubuntu-latest
    env:
      IGGY_CI_BUILD: true
    steps:
      - uses: actions/checkout@v4

      - name: Check Rust versions are synchronized
        run: ./scripts/ci/sync-rust-version.sh --check

  pr-title:
    name: Check PR Title
    if: github.event_name == 'pull_request' && !inputs.skip_pr_title
    runs-on: ubuntu-latest
    env:
      IGGY_CI_BUILD: true
    steps:
      - name: Validate PR Title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
            repo
            deps
          scopes: |
            bdd
            bench
            ci
            cli
            connector
            connectors
            csharp
            deps
            docs
            example
            go
            helm
            integration
            io_uring
            java
            js
            mcp
            proc
            pr_template
            python
            repo
            rust
            sdk
            security
            server
            test
            web
            consensus
            cluster
            metadata
            message_bus
            storage

  license-headers:
    name: Check license headers
    runs-on: ubuntu-latest
    env:
      IGGY_CI_BUILD: true
    steps:
      - uses: actions/checkout@v4

      - name: Check Apache license headers
        run: ./scripts/ci/license-headers.sh --check

  license-list:
    name: Check licenses list
    runs-on: ubuntu-latest
    env:
      IGGY_CI_BUILD: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: ./.github/actions/utils/setup-rust-with-cache
        with:
          enabled: "false" # Don't need cache for just checking licenses

      - name: Install cargo-license
        run: cargo install cargo-license

      - run: ./scripts/ci/licenses-list.sh --check

  markdown:
    name: Markdown lint
    runs-on: ubuntu-latest
    env:
      IGGY_CI_BUILD: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "23"

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Run markdownlint
        run: ./scripts/ci/markdownlint.sh --check

  shellcheck:
    name: Shell scripts lint
    runs-on: ubuntu-latest
    env:
      IGGY_CI_BUILD: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          SHELLCHECK_VERSION="0.11.0"
          wget -qO- "https://github.com/koalaman/shellcheck/releases/download/v${SHELLCHECK_VERSION}/shellcheck-v${SHELLCHECK_VERSION}.linux.x86_64.tar.xz" | tar -xJv
          sudo cp "shellcheck-v${SHELLCHECK_VERSION}/shellcheck" /usr/local/bin/

      - name: Check shell scripts
        run: ./scripts/ci/shellcheck.sh --check

  trailing-whitespace:
    name: Check trailing whitespace
    runs-on: ubuntu-latest
    env:
      IGGY_CI_BUILD: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history to get diff

      - name: Check for trailing whitespace in changed files
        run: ./scripts/ci/trailing-whitespace.sh --check --ci

  trailing-newline:
    name: Check trailing newline
    runs-on: ubuntu-latest
    env:
      IGGY_CI_BUILD: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history to get diff

      - name: Check for trailing newline in changed text files
        run: ./scripts/ci/trailing-newline.sh --check --ci

  summary:
    name: Common checks summary
    needs:
      [
        rust-versions,
        pr-title,
        license-headers,
        license-list,
        markdown,
        shellcheck,
        trailing-whitespace,
        trailing-newline,
      ]
    if: always()
    runs-on: ubuntu-latest
    env:
      IGGY_CI_BUILD: true
    steps:
      - name: Summary
        run: |
          echo "## ðŸ“‹ Common Checks Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|-------------|" >> $GITHUB_STEP_SUMMARY

          # PR-specific checks
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_TITLE="${{ needs.pr-title.result }}"

            # Add emoji based on status
            if [ "$PR_TITLE" = "success" ]; then
              echo "| âœ… PR Title | success | Follows conventional format |" >> $GITHUB_STEP_SUMMARY
            elif [ "$PR_TITLE" = "failure" ]; then
              echo "| âŒ PR Title | failure | Must follow conventional format |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| â­ï¸ PR Title | $PR_TITLE | Check skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| â­ï¸ PR Title | skipped | Not a pull request |" >> $GITHUB_STEP_SUMMARY
          fi

          # Always-run checks
          RUST_VERSIONS="${{ needs.rust-versions.result }}"
          LICENSE_HEADERS="${{ needs.license-headers.result }}"
          LICENSE_LIST="${{ needs.license-list.result }}"
          MARKDOWN="${{ needs.markdown.result }}"

          if [ "$RUST_VERSIONS" = "success" ]; then
            echo "| âœ… Rust Versions | success | All Rust versions synchronized |" >> $GITHUB_STEP_SUMMARY
          elif [ "$RUST_VERSIONS" = "failure" ]; then
            echo "| âŒ Rust Versions | failure | Rust versions mismatch in Dockerfiles |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| â­ï¸ Rust Versions | $RUST_VERSIONS | Check skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$LICENSE_HEADERS" = "success" ]; then
            echo "| âœ… License Headers | success | All files have Apache headers |" >> $GITHUB_STEP_SUMMARY
          elif [ "$LICENSE_HEADERS" = "failure" ]; then
            echo "| âŒ License Headers | failure | Missing Apache license headers |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| â­ï¸ License Headers | $LICENSE_HEADERS | Check skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$LICENSE_LIST" = "success" ]; then
            echo "| âœ… License List | success | Dependencies licenses validated |" >> $GITHUB_STEP_SUMMARY
          elif [ "$LICENSE_LIST" = "failure" ]; then
            echo "| âŒ License List | failure | License list needs update |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| â­ï¸ License List | $LICENSE_LIST | Check skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$MARKDOWN" = "success" ]; then
            echo "| âœ… Markdown Lint | success | All markdown files are valid |" >> $GITHUB_STEP_SUMMARY
          elif [ "$MARKDOWN" = "failure" ]; then
            echo "| âŒ Markdown Lint | failure | Markdown formatting issues found |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| â­ï¸ Markdown Lint | $MARKDOWN | Check skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          SHELLCHECK="${{ needs.shellcheck.result }}"
          if [ "$SHELLCHECK" = "success" ]; then
            echo "| âœ… Shellcheck | success | All shell scripts are valid |" >> $GITHUB_STEP_SUMMARY
          elif [ "$SHELLCHECK" = "failure" ]; then
            echo "| âŒ Shellcheck | failure | Shell script issues found |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| â­ï¸ Shellcheck | $SHELLCHECK | Check skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          TRAILING="${{ needs.trailing-whitespace.result }}"
          if [ "$TRAILING" = "success" ]; then
            echo "| âœ… Trailing Whitespace | success | No trailing whitespace found |" >> $GITHUB_STEP_SUMMARY
          elif [ "$TRAILING" = "failure" ]; then
            echo "| âŒ Trailing Whitespace | failure | Trailing whitespace detected |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| â­ï¸ Trailing Whitespace | $TRAILING | Check skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          TRAILING_NL="${{ needs.trailing-newline.result }}"
          if [ "$TRAILING_NL" = "success" ]; then
            echo "| âœ… Trailing Newline | success | All text files have trailing newlines |" >> $GITHUB_STEP_SUMMARY
          elif [ "$TRAILING_NL" = "failure" ]; then
            echo "| âŒ Trailing Newline | failure | Missing trailing newlines detected |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| â­ï¸ Trailing Newline | $TRAILING_NL | Check skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "### âŒ Some checks failed" >> $GITHUB_STEP_SUMMARY
            echo "Please review the failed checks above and fix the issues." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ contains(needs.*.result, 'skipped') }}" == "true" ]]; then
            echo "### âš ï¸ Some checks were skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
          fi
